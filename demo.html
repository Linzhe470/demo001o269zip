<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>ÈôÑËøëÁöÑ‰æøÂà©ÂïÜÂ∫ó</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script
      type="text/javascript"
      src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"
    ></script>
    <script
      type="text/javascript"
      src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <link href="./css/style.css" rel="stylesheet" />
    <!-- ÂÖ±Áî® AFRAME ‰∫ã‰ª∂Ë®ªÂÜä -->
    <script src="./scripts/AFRAMEregister.js"></script>
    <!--  -->
    <!-- <script>
      // Êèê‰æõË®òÈåÑÊòØÂê¶Â∑≤‰∏ãËºâÂÆå poi Ë≥áÊñôÔºåÊñº gps Êõ¥Êñ∞ÊôÇ‰∏çÂÜçËºâ‰∏ÄÊ¨°
      let poi_download = false;

      window.onload = () => {
        const el = document.querySelector("[gps-new-camera]");
        const elInfo = document.querySelector(".arjs-loader-div");

        elInfo.textContent = `GPS Ë®äËôüÂèäË≥áÊñôËÆÄÂèñ‰∏≠`;

        el.addEventListener("gps-camera-update-position", (e) => {
          if ("geolocation" in navigator) {
            elInfo.textContent = `üü¢Êúâ|navigator‰∏≠Â∑≤ÂÖ∑Êúâgeolocation`;
            const options = {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0,
            };
            //https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/getCurrentPosition
            // Âü∑Ë°åÂÆö‰Ωçnavigator.geolocation.getCurrentPosition
            navigator.geolocation.getCurrentPosition(
              (position) => {
                // È°ØÁ§∫ GPS Á≤æÂ∫¶
                document.getElementById(
                  "gps-info"
                ).textContent += ` Ë™§Â∑Æ ${position.coords.accuracy.toFixed(
                  1
                )} m`;
                elInfo.textContent = `Âü∑Ë°ågetCurrentPosition()`;
              }
              //,()=>{},options
            );

            // È°ØÁ§∫ÊäìÂà∞ÁöÑ GPS ÂùêÊ®ôË≥áË®ä
            document.getElementById(
              "gps-info"
            ).textContent = `lon ${e.detail.position.longitude.toFixed(
              4
            )} lat ${e.detail.position.latitude.toFixed(4)}`;
            elInfo.textContent = `ÊäìÂà∞GPS`;
            elInfo.textContent = `üî¥poi_download:${poi_download}`;

            if (!poi_download) {
              // elInfo.textContent = `üî¥ÁÑ°poi_download`;
              // ‰ΩøÁî® api Âç≥ÊôÇÊü•ÂõûÁöÑË≥áÊñô
              // than use it to load from remote APIs some places nearby
              // dynamicLoadPlaces(e.detail.position)
              elInfo.textContent = `üü†Âü∑Ë°ådynamicLoadPlaces()|ÂëºÂè´QueryHandler.ashx`;
              elInfo.textContent = `üü†Âü∑Ë°åx${e.detail.position.longitude}y${e.detail.position.latitude}`;
              fetch("QueryHandler.ashx", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-RW-Api-Key": "googleplacenearby",
                  "X-RW-Api-Buffer-Meters": 200,
                  "X-RW-Api-Lng": e.detail.position.longitude,
                  "X-RW-Api-Lat": e.detail.position.latitude,
                },
              }).then((response) => {
                if (!response.ok) {
                  elInfo.textContent = `üî¥Âü∑Ë°ådynamicLoadPlaces()Â§±Êïó`;
                  // throw new Error("Network response was not ok");
                }
                elInfo.textContent = `üü¢Âü∑Ë°ådynamicLoadPlaces()ÊàêÂäü`;
                // return response.json();
                console.log(response.json());
                let { places } = response.json();

                if (places === undefined) {
                  //Êâæ‰∏çÂà∞Âú∞Ê®ô
                  elInfo.textContent = `‚óè ÁõÆÂâç‰ΩçÁΩÆÈôÑËøëÊü•Ë©¢‰∏çÂà∞‰ªª‰ΩïÂú∞Ê®ôË≥áË®äÔºåË´ãÁßªÂãïÂà∞ÂÖ∂‰ªñ‰ΩçÁΩÆÂæåÈªûÈÅ∏‰∏ãÊñπ„ÄêÈáçÊï¥„ÄëÈàïÈÄ≤Ë°åÊü•Ë©¢„ÄÇ`;
                  alert(
                    `‚óè ÁõÆÂâç‰ΩçÁΩÆÈôÑËøëÊü•Ë©¢‰∏çÂà∞‰ªª‰ΩïÂú∞Ê®ôË≥áË®äÔºåË´ãÁßªÂãïÂà∞ÂÖ∂‰ªñ‰ΩçÁΩÆÂæåÈªûÈÅ∏‰∏ãÊñπ„ÄêÈáçÊï¥„ÄëÈàïÈÄ≤Ë°åÊü•Ë©¢„ÄÇ`
                  );
                } else {
                  // renderPlaces(places);
                  elInfo.textContent = `‚óè ${places.length} Á≠ÜË≥áÊñôËºâÂÖ•ÂÆåÊàêÔºåË´ãËΩâÂãïÈè°È†≠ÊâæÂ∞ãÁâ©‰ª∂„ÄÇ\n‚óè ÈªûÈÅ∏Áâ©‰ª∂ÂèØÈ°ØÁ§∫Ë≥áË®ä„ÄÇ\n‚óè „ÄêÈáçÊï¥„ÄëÈàïÂèØÈáçÊñ∞Êü•Ë©¢ÈôÑËøëÂú∞Ê®ô„ÄÇ`;

                  alert(
                    `‚óè ${places.length} Á≠ÜË≥áÊñôËºâÂÖ•ÂÆåÊàêÔºåË´ãËΩâÂãïÈè°È†≠ÊâæÂ∞ãÁâ©‰ª∂„ÄÇ\n‚óè ÈªûÈÅ∏Áâ©‰ª∂ÂèØÈ°ØÁ§∫Ë≥áË®ä„ÄÇ\n‚óè „ÄêÈáçÊï¥„ÄëÈàïÂèØÈáçÊñ∞Êü•Ë©¢ÈôÑËøëÂú∞Ê®ô„ÄÇ`
                  );
                }
                //   poi_download = true;
                // let scene = document.querySelector("a-scene");
                // // Â¢ûÂä†ÂÖ¨Âè∏ Ë≥áÊñô
                // const rwlogoEntity = document.createElement("a-entity");
                // rwlogoEntity.setAttribute("gps-new-entity-place", {
                //   latitude: e.detail.position.latitude,
                //   longitude: e.detail.position.longitude,
                // });
                // // Logo
                // elInfo.textContent = `üü¢Êñ∞Â¢ûa-image`;
                // const rwlogo = document.createElement("a-image");
                // rwlogo.setAttribute("look-at", "#acamera");
                // rwlogo.setAttribute("src", "./assets/RWLOGO-02-50.png");
                // rwlogo.setAttribute("scale", { x: 10, y: 10, z: 10 });
                // rwlogo.setAttribute("rotation", { x: -90, y: 0, z: 0 });
                // rwlogo.setAttribute("position", { x: 0, y: -30, z: 0 });
                // rwlogoEntity.appendChild(rwlogo);

                // scene.appendChild(rwlogoEntity);
              });
              // return dynamicLoadPlaces(e.detail.position).then((apiPlaces) => {
              //   let { places } = apiPlaces;
              //   if (places === undefined) {
              //     //Êâæ‰∏çÂà∞Âú∞Ê®ô
              //     alert(
              //       `‚óè ÁõÆÂâç‰ΩçÁΩÆÈôÑËøëÊü•Ë©¢‰∏çÂà∞‰ªª‰ΩïÂú∞Ê®ôË≥áË®äÔºåË´ãÁßªÂãïÂà∞ÂÖ∂‰ªñ‰ΩçÁΩÆÂæåÈªûÈÅ∏‰∏ãÊñπ„ÄêÈáçÊï¥„ÄëÈàïÈÄ≤Ë°åÊü•Ë©¢„ÄÇ`
              //     );
              //   } else {
              //     renderPlaces(places);
              //     alert(
              //       `‚óè ${places.length} Á≠ÜË≥áÊñôËºâÂÖ•ÂÆåÊàêÔºåË´ãËΩâÂãïÈè°È†≠ÊâæÂ∞ãÁâ©‰ª∂„ÄÇ\n‚óè ÈªûÈÅ∏Áâ©‰ª∂ÂèØÈ°ØÁ§∫Ë≥áË®ä„ÄÇ\n‚óè „ÄêÈáçÊï¥„ÄëÈàïÂèØÈáçÊñ∞Êü•Ë©¢ÈôÑËøëÂú∞Ê®ô„ÄÇ`
              //     );
              //   }
              //   // ÈóúÈñâËºâÂÖ•‰∏≠Ë®äÊÅØÈÅÆÁΩ©
              //   document.querySelector(".arjs-loader").style.display = "none";
              //   poi_download = true;

              //   let scene = document.querySelector("a-scene");
              //   // Â¢ûÂä†ÂÖ¨Âè∏ Ë≥áÊñô
              //   const rwlogoEntity = document.createElement("a-entity");
              //   rwlogoEntity.setAttribute("gps-new-entity-place", {
              //     latitude: e.detail.position.latitude,
              //     longitude: e.detail.position.longitude,
              //   });
              //   // Logo
              //   const rwlogo = document.createElement("a-image");
              //   rwlogo.setAttribute("look-at", "#acamera");
              //   rwlogo.setAttribute("src", "./assets/RWLOGO-02-50.png");
              //   rwlogo.setAttribute("scale", { x: 10, y: 10, z: 10 });
              //   rwlogo.setAttribute("rotation", { x: -90, y: 0, z: 0 });
              //   rwlogo.setAttribute("position", { x: 0, y: -30, z: 0 });
              //   rwlogoEntity.appendChild(rwlogo);

              //   scene.appendChild(rwlogoEntity);
              // });
            }
          } else {
            elInfo.textContent = `üî¥ÁÑ°|navigator‰∏≠Êú™ÂÖ∑Êúâgeolocation`;
            /* geolocation IS NOT available */
          }
        });

        // Ë®ªÂÜä Êõ¥Êñ∞Ë≥áÊñô ÈàïÁöÑËôïÁêÜ‰∫ã‰ª∂
        document
          .querySelector(".reload-poi-button")
          .addEventListener("click", function () {
            window.location.reload();
          });
      };

      // ÈÄèÈÅé Google Place searchNearby Êñ∞Áâà API ÂèñÂæóÂú∞Ê®ôË≥áÊñô
      function dynamicLoadPlaces(position) {
        elInfo.textContent = `üü†Âü∑Ë°ådynamicLoadPlaces()|ÂëºÂè´QueryHandler.ashx`;
        return fetch("QueryHandler.ashx", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-RW-Api-Key": "googleplacenearby",
            "X-RW-Api-Buffer-Meters": 200,
            "X-RW-Api-Lng": position.longitude,
            "X-RW-Api-Lat": position.latitude,
          },
        }).then((response) => {
          if (!response.ok) {
            elInfo.textContent = `üî¥Âü∑Ë°ådynamicLoadPlaces()Â§±Êïó`;
            throw new Error("Network response was not ok");
          }
          elInfo.textContent = `üü¢Âü∑Ë°ådynamicLoadPlaces()ÊàêÂäü`;
          return response.json();
        });
      }

      // Â∞áÂú∞Ê®ôË≥áÊñôÁπ™Ë£ΩÂà∞ a-scene ‰∏≠
      function renderPlaces(places) {
        //alert(JSON.stringify(places))
        let scene = document.querySelector("a-scene");

        places.forEach((place) => {
          let latitude = place.location.latitude;
          let longitude = place.location.longitude;
          let displayName = place.displayName.text;
          let formattedAddress = place.formattedAddress;

          const poiEntity = document.createElement("a-entity");
          poiEntity.setAttribute("gps-new-entity-place", {
            latitude: latitude,
            longitude: longitude,
          });

          const sphere = document.createElement("a-sphere");
          sphere.setAttribute("scale", { x: 2, y: 2, z: 2 });
          sphere.setAttribute("look-at", "#acamera");
          sphere.setAttribute("material", { color: "red" });
          sphere.setAttribute("position", { x: 0, y: 0, z: 0 });
          sphere.setAttribute("opacity", "0.2");

          const imgtext = document.createElement("a-image");
          const textScale = 15;
          imgtext.setAttribute("opacity", "0.8");
          imgtext.setAttribute("look-at", "#acamera");
          imgtext.setAttribute("scale", {
            x: textScale,
            y: textScale,
            z: textScale,
          });
          imgtext.setAttribute("rotation", { x: 0, y: 0, z: 0 });
          imgtext.setAttribute("position", { x: 0, y: 12, z: 0 });

          const displayTextElement = document.createElement("div");
          displayTextElement.className = "displayTextElement";
          displayTextElement.innerHTML = displayName.replace(" ", "<br>");
          //Âä†Âà∞ body ÂæåÊâçÁï´ÁöÑÂá∫‰æÜ
          document.body.appendChild(displayTextElement);
          html2canvas(displayTextElement, { backgroundColor: null }).then(
            (canvas) => {
              imgtext.setAttribute("src", canvas.toDataURL("image/png"));

              poiEntity.appendChild(sphere);
              poiEntity.appendChild(imgtext);

              // Â¢ûÂä†ÈªûÊìä‰∫ã‰ª∂
              poiEntity.addEventListener("click", function () {
                alert(`${displayName}\n${formattedAddress}`);
              });
              scene.appendChild(poiEntity);
            }
          );
        });
      }
    </script> -->
    <script>
      // Êèê‰æõË®òÈåÑÊòØÂê¶Â∑≤‰∏ãËºâÂÆå poi Ë≥áÊñôÔºåÊñº gps Êõ¥Êñ∞ÊôÇ‰∏çÂÜçËºâ‰∏ÄÊ¨°
      let poi_download = false;
      
      window.onload = () => {
        const elInfo = document.querySelector(".arjs-loader-div");
        elInfo.textContent = `GPS Ë®äËôüÂèäË≥áÊñôËÆÄÂèñ‰∏≠`;
        
        const el = document.querySelector("[gps-new-camera]");
        
        elInfo.textContent = `${el.toString()}`;
        el.addEventListener("gps-camera-update-position", (e) => {
          if ("geolocation" in navigator) {
            const options = {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0,
            };
            //https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/getCurrentPosition
            navigator.geolocation.getCurrentPosition(
              (position) => {
                // È°ØÁ§∫ GPS Á≤æÂ∫¶
                document.getElementById(
                  "gps-info"
                ).textContent += ` Ë™§Â∑Æ ${position.coords.accuracy.toFixed(
                  1
                )} m`;
              }
              //,()=>{},options
            );

            // È°ØÁ§∫ÊäìÂà∞ÁöÑ GPS ÂùêÊ®ôË≥áË®ä
            document.getElementById(
              "gps-info"
            ).textContent = `lon ${e.detail.position.longitude.toFixed(
              4
            )} lat ${e.detail.position.latitude.toFixed(4)}`;

            if (!poi_download) {
              // ‰ΩøÁî® api Âç≥ÊôÇÊü•ÂõûÁöÑË≥áÊñô
              // than use it to load from remote APIs some places nearby
              return dynamicLoadPlaces(e.detail.position).then((apiPlaces) => {
                let { places } = apiPlaces;
                if (places === undefined) {
                  //Êâæ‰∏çÂà∞Âú∞Ê®ô
                  alert(
                    `‚óè ÁõÆÂâç‰ΩçÁΩÆÈôÑËøëÊü•Ë©¢‰∏çÂà∞‰ªª‰ΩïÂú∞Ê®ôË≥áË®äÔºåË´ãÁßªÂãïÂà∞ÂÖ∂‰ªñ‰ΩçÁΩÆÂæåÈªûÈÅ∏‰∏ãÊñπ„ÄêÈáçÊï¥„ÄëÈàïÈÄ≤Ë°åÊü•Ë©¢„ÄÇ`
                  );
                } else {
                  renderPlaces(places);
                  alert(
                    `‚óè ${places.length} Á≠ÜË≥áÊñôËºâÂÖ•ÂÆåÊàêÔºåË´ãËΩâÂãïÈè°È†≠ÊâæÂ∞ãÁâ©‰ª∂„ÄÇ\n‚óè ÈªûÈÅ∏Áâ©‰ª∂ÂèØÈ°ØÁ§∫Ë≥áË®ä„ÄÇ\n‚óè „ÄêÈáçÊï¥„ÄëÈàïÂèØÈáçÊñ∞Êü•Ë©¢ÈôÑËøëÂú∞Ê®ô„ÄÇ`
                  );
                }
                // ÈóúÈñâËºâÂÖ•‰∏≠Ë®äÊÅØÈÅÆÁΩ©
                document.querySelector(".arjs-loader").style.display = "none";
                poi_download = true;

                let scene = document.querySelector("a-scene");
                // Â¢ûÂä†ÂÖ¨Âè∏ Ë≥áÊñô
                const rwlogoEntity = document.createElement("a-entity");
                rwlogoEntity.setAttribute("gps-new-entity-place", {
                  latitude: e.detail.position.latitude,
                  longitude: e.detail.position.longitude,
                });
                // Logo
                const rwlogo = document.createElement("a-image");
                rwlogo.setAttribute("look-at", "#acamera");
                rwlogo.setAttribute("src", "./assets/RWLOGO-02-50.png");
                rwlogo.setAttribute("scale", { x: 10, y: 10, z: 10 });
                rwlogo.setAttribute("rotation", { x: -90, y: 0, z: 0 });
                rwlogo.setAttribute("position", { x: 0, y: -30, z: 0 });
                rwlogoEntity.appendChild(rwlogo);

                scene.appendChild(rwlogoEntity);
              });
            }
          } else {
            /* geolocation IS NOT available */
          }
        });

        // Ë®ªÂÜä Êõ¥Êñ∞Ë≥áÊñô ÈàïÁöÑËôïÁêÜ‰∫ã‰ª∂
        document
          .querySelector(".reload-poi-button")
          .addEventListener("click", function () {
            window.location.reload();
          });
      };

      // ÈÄèÈÅé Google Place searchNearby Êñ∞Áâà API ÂèñÂæóÂú∞Ê®ôË≥áÊñô
      function dynamicLoadPlaces(position) {
        return fetch("QueryHandler.ashx", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-RW-Api-Key": "googleplacenearby",
            "X-RW-Api-Buffer-Meters": 200,
            "X-RW-Api-Lng": position.longitude,
            "X-RW-Api-Lat": position.latitude,
          },
        }).then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        });
      }

      // Â∞áÂú∞Ê®ôË≥áÊñôÁπ™Ë£ΩÂà∞ a-scene ‰∏≠
      function renderPlaces(places) {
        //alert(JSON.stringify(places))
        let scene = document.querySelector("a-scene");

        places.forEach((place) => {
          let latitude = place.location.latitude;
          let longitude = place.location.longitude;
          let displayName = place.displayName.text;
          let formattedAddress = place.formattedAddress;

          const poiEntity = document.createElement("a-entity");
          poiEntity.setAttribute("gps-new-entity-place", {
            latitude: latitude,
            longitude: longitude,
          });

          const sphere = document.createElement("a-sphere");
          sphere.setAttribute("scale", { x: 2, y: 2, z: 2 });
          sphere.setAttribute("look-at", "#acamera");
          sphere.setAttribute("material", { color: "red" });
          sphere.setAttribute("position", { x: 0, y: 0, z: 0 });
          sphere.setAttribute("opacity", "0.2");

          const imgtext = document.createElement("a-image");
          const textScale = 15;
          imgtext.setAttribute("opacity", "0.8");
          imgtext.setAttribute("look-at", "#acamera");
          imgtext.setAttribute("scale", {
            x: textScale,
            y: textScale,
            z: textScale,
          });
          imgtext.setAttribute("rotation", { x: 0, y: 0, z: 0 });
          imgtext.setAttribute("position", { x: 0, y: 12, z: 0 });

          const displayTextElement = document.createElement("div");
          displayTextElement.className = "displayTextElement";
          displayTextElement.innerHTML = displayName.replace(" ", "<br>");
          //Âä†Âà∞ body ÂæåÊâçÁï´ÁöÑÂá∫‰æÜ
          document.body.appendChild(displayTextElement);
          html2canvas(displayTextElement, { backgroundColor: null }).then(
            (canvas) => {
              imgtext.setAttribute("src", canvas.toDataURL("image/png"));

              poiEntity.appendChild(sphere);
              poiEntity.appendChild(imgtext);

              // Â¢ûÂä†ÈªûÊìä‰∫ã‰ª∂
              poiEntity.addEventListener("click", function () {
                alert(`${displayName}\n${formattedAddress}`);
              });
              scene.appendChild(poiEntity);
            }
          );
        });
      }
    </script>
  </head>

  <body style="margin: 0px; overflow: hidden">
    <div class="arjs-loader">
      <div class="arjs-loader-div"></div>
    </div>
    <div class="header">
      ARÔºöÈ°ØÁ§∫7
      <button class="reload-poi-button">ÈáçÊï¥</button>
    </div>
    <div class="footer">
      <span id="gps-info">GPS...</span>
      <button class="reload-poi-button">ÈáçÊï¥</button>
    </div>
    <a-scene
      vr-mode-ui="enabled: false"
      cursor="rayOrigin: mouse"
      raycaster="near: 0; far: 50000"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false"
      renderer="antialias: true; alpha: true"
      gesture-detector
    >
      <a-camera
        id="acamera"
        gps-new-camera="gpsMinDistance: 5; positionMinAccuracy: 30; alert: false;"
      ></a-camera>
    </a-scene>
  </body>
</html>
