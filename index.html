<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>é™„è¿‘çš„ä¾¿åˆ©å•†åº—</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script
      type="text/javascript"
      src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"
    ></script>
    <script
      type="text/javascript"
      src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"
    ></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&display=swap"
      rel="stylesheet"
    />

    <link href="./css/style2.css" rel="stylesheet" />
    <!-- å…±ç”¨ AFRAME äº‹ä»¶è¨»å†Š -->
    <script src="./scripts/AFRAMEregister.js"></script>
    <script>
      // æä¾›è¨˜éŒ„æ˜¯å¦å·²ä¸‹è¼‰å®Œ poi è³‡æ–™ï¼Œæ–¼ gps æ›´æ–°æ™‚ä¸å†è¼‰ä¸€æ¬¡
      let poi_download = false;

      window.onload = () => {
        const el = document.querySelector("[gps-new-camera]");
        const elInfo = document.querySelector(".arjs-loader-div");

        elInfo.textContent = `GPS è¨Šè™ŸåŠè³‡æ–™è®€å–ä¸­`;

        el.addEventListener("gps-camera-update-position", (e) => {
          if ("geolocation" in navigator) {
            elInfo.textContent = `ğŸŸ¢æœ‰|navigatorä¸­å·²å…·æœ‰geolocation`;
            const options = {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0,
            };
            //https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/getCurrentPosition
            // åŸ·è¡Œå®šä½navigator.geolocation.getCurrentPosition
            navigator.geolocation.getCurrentPosition(
              (position) => {
                // é¡¯ç¤º GPS ç²¾åº¦
                document.getElementById(
                  "gps-info"
                ).textContent += ` èª¤å·® ${position.coords.accuracy.toFixed(
                  1
                )} m`;
                elInfo.textContent = `åŸ·è¡ŒgetCurrentPosition()`;
              }
              //,()=>{},options
            );

            // é¡¯ç¤ºæŠ“åˆ°çš„ GPS åæ¨™è³‡è¨Š
            document.getElementById(
              "gps-info"
            ).textContent = `lon ${e.detail.position.longitude.toFixed(
              4
            )} lat ${e.detail.position.latitude.toFixed(4)}`;
            elInfo.textContent = `æŠ“åˆ°GPS`;
            elInfo.textContent = `ğŸ”´poi_download:${poi_download}`;

            if (!poi_download) {
              // elInfo.textContent = `ğŸ”´ç„¡poi_download`;
              // ä½¿ç”¨ api å³æ™‚æŸ¥å›çš„è³‡æ–™
              // than use it to load from remote APIs some places nearby
              // dynamicLoadPlaces(e.detail.position)
              elInfo.textContent = `ğŸŸ åŸ·è¡ŒdynamicLoadPlaces()|å‘¼å«QueryHandler.ashx`;
              elInfo.textContent = `ğŸŸ åŸ·è¡Œx${e.detail.position.longitude}y${e.detail.position.latitude}`;
              fetch("QueryHandler.ashx", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-RW-Api-Key": "googleplacenearby",
                  "X-RW-Api-Buffer-Meters": 200,
                  "X-RW-Api-Lng": e.detail.position.longitude,
                  "X-RW-Api-Lat": e.detail.position.latitude,
                },
              }).then((response) => {
                if (!response.ok) {
                  elInfo.textContent = `ğŸ”´åŸ·è¡ŒdynamicLoadPlaces()å¤±æ•—`;
                  // throw new Error("Network response was not ok");
                }
                elInfo.textContent = `ğŸŸ¢åŸ·è¡ŒdynamicLoadPlaces()æˆåŠŸ`;
                // return response.json();
               console.log(response.json())
                let { places } = response.json();

                if (places === undefined) {
                  //æ‰¾ä¸åˆ°åœ°æ¨™
                  elInfo.textContent = `â— ç›®å‰ä½ç½®é™„è¿‘æŸ¥è©¢ä¸åˆ°ä»»ä½•åœ°æ¨™è³‡è¨Šï¼Œè«‹ç§»å‹•åˆ°å…¶ä»–ä½ç½®å¾Œé»é¸ä¸‹æ–¹ã€é‡æ•´ã€‘éˆ•é€²è¡ŒæŸ¥è©¢ã€‚`;
                  alert(
                    `â— ç›®å‰ä½ç½®é™„è¿‘æŸ¥è©¢ä¸åˆ°ä»»ä½•åœ°æ¨™è³‡è¨Šï¼Œè«‹ç§»å‹•åˆ°å…¶ä»–ä½ç½®å¾Œé»é¸ä¸‹æ–¹ã€é‡æ•´ã€‘éˆ•é€²è¡ŒæŸ¥è©¢ã€‚`
                  );
                } else {
                  // renderPlaces(places);
                  elInfo.textContent =  `â— ${places.length} ç­†è³‡æ–™è¼‰å…¥å®Œæˆï¼Œè«‹è½‰å‹•é¡é ­æ‰¾å°‹ç‰©ä»¶ã€‚\nâ— é»é¸ç‰©ä»¶å¯é¡¯ç¤ºè³‡è¨Šã€‚\nâ— ã€é‡æ•´ã€‘éˆ•å¯é‡æ–°æŸ¥è©¢é™„è¿‘åœ°æ¨™ã€‚`

                  alert(
                    `â— ${places.length} ç­†è³‡æ–™è¼‰å…¥å®Œæˆï¼Œè«‹è½‰å‹•é¡é ­æ‰¾å°‹ç‰©ä»¶ã€‚\nâ— é»é¸ç‰©ä»¶å¯é¡¯ç¤ºè³‡è¨Šã€‚\nâ— ã€é‡æ•´ã€‘éˆ•å¯é‡æ–°æŸ¥è©¢é™„è¿‘åœ°æ¨™ã€‚`
                  );
                }
                //   poi_download = true;
                // let scene = document.querySelector("a-scene");
                // // å¢åŠ å…¬å¸ è³‡æ–™
                // const rwlogoEntity = document.createElement("a-entity");
                // rwlogoEntity.setAttribute("gps-new-entity-place", {
                //   latitude: e.detail.position.latitude,
                //   longitude: e.detail.position.longitude,
                // });
                // // Logo
                // elInfo.textContent = `ğŸŸ¢æ–°å¢a-image`;
                // const rwlogo = document.createElement("a-image");
                // rwlogo.setAttribute("look-at", "#acamera");
                // rwlogo.setAttribute("src", "./assets/RWLOGO-02-50.png");
                // rwlogo.setAttribute("scale", { x: 10, y: 10, z: 10 });
                // rwlogo.setAttribute("rotation", { x: -90, y: 0, z: 0 });
                // rwlogo.setAttribute("position", { x: 0, y: -30, z: 0 });
                // rwlogoEntity.appendChild(rwlogo);

                // scene.appendChild(rwlogoEntity);
              });
              // return dynamicLoadPlaces(e.detail.position).then((apiPlaces) => {
              //   let { places } = apiPlaces;
              //   if (places === undefined) {
              //     //æ‰¾ä¸åˆ°åœ°æ¨™
              //     alert(
              //       `â— ç›®å‰ä½ç½®é™„è¿‘æŸ¥è©¢ä¸åˆ°ä»»ä½•åœ°æ¨™è³‡è¨Šï¼Œè«‹ç§»å‹•åˆ°å…¶ä»–ä½ç½®å¾Œé»é¸ä¸‹æ–¹ã€é‡æ•´ã€‘éˆ•é€²è¡ŒæŸ¥è©¢ã€‚`
              //     );
              //   } else {
              //     renderPlaces(places);
              //     alert(
              //       `â— ${places.length} ç­†è³‡æ–™è¼‰å…¥å®Œæˆï¼Œè«‹è½‰å‹•é¡é ­æ‰¾å°‹ç‰©ä»¶ã€‚\nâ— é»é¸ç‰©ä»¶å¯é¡¯ç¤ºè³‡è¨Šã€‚\nâ— ã€é‡æ•´ã€‘éˆ•å¯é‡æ–°æŸ¥è©¢é™„è¿‘åœ°æ¨™ã€‚`
              //     );
              //   }
              //   // é—œé–‰è¼‰å…¥ä¸­è¨Šæ¯é®ç½©
              //   document.querySelector(".arjs-loader").style.display = "none";
              //   poi_download = true;

              //   let scene = document.querySelector("a-scene");
              //   // å¢åŠ å…¬å¸ è³‡æ–™
              //   const rwlogoEntity = document.createElement("a-entity");
              //   rwlogoEntity.setAttribute("gps-new-entity-place", {
              //     latitude: e.detail.position.latitude,
              //     longitude: e.detail.position.longitude,
              //   });
              //   // Logo
              //   const rwlogo = document.createElement("a-image");
              //   rwlogo.setAttribute("look-at", "#acamera");
              //   rwlogo.setAttribute("src", "./assets/RWLOGO-02-50.png");
              //   rwlogo.setAttribute("scale", { x: 10, y: 10, z: 10 });
              //   rwlogo.setAttribute("rotation", { x: -90, y: 0, z: 0 });
              //   rwlogo.setAttribute("position", { x: 0, y: -30, z: 0 });
              //   rwlogoEntity.appendChild(rwlogo);

              //   scene.appendChild(rwlogoEntity);
              // });
            }
          } else {
            elInfo.textContent = `ğŸ”´ç„¡|navigatorä¸­æœªå…·æœ‰geolocation`;
            /* geolocation IS NOT available */
          }
        });

        // è¨»å†Š æ›´æ–°è³‡æ–™ éˆ•çš„è™•ç†äº‹ä»¶
        document
          .querySelector(".reload-poi-button")
          .addEventListener("click", function () {
            window.location.reload();
          });
      };

      // é€é Google Place searchNearby æ–°ç‰ˆ API å–å¾—åœ°æ¨™è³‡æ–™
      function dynamicLoadPlaces(position) {
        elInfo.textContent = `ğŸŸ åŸ·è¡ŒdynamicLoadPlaces()|å‘¼å«QueryHandler.ashx`;
        return fetch("QueryHandler.ashx", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-RW-Api-Key": "googleplacenearby",
            "X-RW-Api-Buffer-Meters": 200,
            "X-RW-Api-Lng": position.longitude,
            "X-RW-Api-Lat": position.latitude,
          },
        }).then((response) => {
          if (!response.ok) {
            elInfo.textContent = `ğŸ”´åŸ·è¡ŒdynamicLoadPlaces()å¤±æ•—`;
            throw new Error("Network response was not ok");
          }
          elInfo.textContent = `ğŸŸ¢åŸ·è¡ŒdynamicLoadPlaces()æˆåŠŸ`;
          return response.json();
        });
      }

      // å°‡åœ°æ¨™è³‡æ–™ç¹ªè£½åˆ° a-scene ä¸­
      function renderPlaces(places) {
        //alert(JSON.stringify(places))
        let scene = document.querySelector("a-scene");

        places.forEach((place) => {
          let latitude = place.location.latitude;
          let longitude = place.location.longitude;
          let displayName = place.displayName.text;
          let formattedAddress = place.formattedAddress;

          const poiEntity = document.createElement("a-entity");
          poiEntity.setAttribute("gps-new-entity-place", {
            latitude: latitude,
            longitude: longitude,
          });

          const sphere = document.createElement("a-sphere");
          sphere.setAttribute("scale", { x: 2, y: 2, z: 2 });
          sphere.setAttribute("look-at", "#acamera");
          sphere.setAttribute("material", { color: "red" });
          sphere.setAttribute("position", { x: 0, y: 0, z: 0 });
          sphere.setAttribute("opacity", "0.2");

          const imgtext = document.createElement("a-image");
          const textScale = 15;
          imgtext.setAttribute("opacity", "0.8");
          imgtext.setAttribute("look-at", "#acamera");
          imgtext.setAttribute("scale", {
            x: textScale,
            y: textScale,
            z: textScale,
          });
          imgtext.setAttribute("rotation", { x: 0, y: 0, z: 0 });
          imgtext.setAttribute("position", { x: 0, y: 12, z: 0 });

          const displayTextElement = document.createElement("div");
          displayTextElement.className = "displayTextElement";
          displayTextElement.innerHTML = displayName.replace(" ", "<br>");
          //åŠ åˆ° body å¾Œæ‰ç•«çš„å‡ºä¾†
          document.body.appendChild(displayTextElement);
          html2canvas(displayTextElement, { backgroundColor: null }).then(
            (canvas) => {
              imgtext.setAttribute("src", canvas.toDataURL("image/png"));

              poiEntity.appendChild(sphere);
              poiEntity.appendChild(imgtext);

              // å¢åŠ é»æ“Šäº‹ä»¶
              poiEntity.addEventListener("click", function () {
                alert(`${displayName}\n${formattedAddress}`);
              });
              scene.appendChild(poiEntity);
            }
          );
        });
      }
    </script>
  </head>

  <body style="margin: 0px; overflow: hidden">
    <div class="arjs-loader">
      <div class="arjs-loader-div"></div>
    </div>
    <div class="header">
      ARï¼šé¡¯ç¤º7
      <button class="reload-poi-button">é‡æ•´</button>
    </div>
    <div class="footer">
      <span id="gps-info">GPS...</span>
      <button class="reload-poi-button">é‡æ•´</button>
    </div>
    <a-scene
      vr-mode-ui="enabled: false"
      cursor="rayOrigin: mouse"
      raycaster="near: 0; far: 50000"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false"
      renderer="antialias: true; alpha: true"
      gesture-detector
    >
      <a-camera
        id="acamera"
        gps-new-camera="gpsMinDistance: 5; positionMinAccuracy: 30; alert: false;"
      ></a-camera>
    </a-scene>
  </body>
</html>
